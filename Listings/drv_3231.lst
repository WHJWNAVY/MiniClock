C51 COMPILER V9.59.0.0   DRV_3231                                                          05/06/2019 23:08:40 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE DRV_3231
OBJECT MODULE PLACED IN .\Objects\drv_3231.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE src\drv_3231.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\src) DEBUG PRINT(.\Li
                    -stings\drv_3231.lst) TABS(2) OBJECT(.\Objects\drv_3231.obj)

line level    source

   1          #include "drv_3231.h"
   2          #include "gpio_i2c.h"
   3          
   4          //sbit DS3231_IIC_SDA    = P1 ^ 7;
   5          //sbit DS3231_IIC_SCL    = P1 ^ 5;
   6          
   7          #define DEV_ADDR_DS3231  0xd0    /* DS3231 slave address (write) */
   8          
   9          uchar code ds3231_regaddr[7] = {0x06, 0x03, 0x05, 0x04, 0x02, 0x01, 0x00};//ds3231地址,年周月日时分秒
  10          
  11          /*****************************************************************************
  12           函 数 名  : ds3231_set_time
  13           功能描述  : 设置当前时间
  14           输入参数  : time   要设置的时间
  15           输出参数  : 无
  16           返 回 值  : 无
  17          *****************************************************************************/
  18          void ds3231_set_time(rtc_time_t *time)
  19          {
  20   1          uchar i = 0, j = 0;
  21   1          uchar xdata rtc_time[7] = {0};
  22   1      
  23   1          rtc_time[0] = ((time->year > 99) ? 99 : time->year);//0-99
  24   1          rtc_time[1] = ((time->week > 7) ? 7 : \
  25   1                         ((time->week < 1) ? 1 : time->week));//1-7
  26   1          rtc_time[2] = ((time->month > 12) ? 12 : \
  27   1                         ((time->month < 1) ? 1 : time->month));//1-12
  28   1          rtc_time[3] = ((time->day > 31) ? 31 : \
  29   1                         ((time->day < 1) ? 1 : time->day));//1-31
  30   1          rtc_time[4] = ((time->hour > 23) ? 23 : time->hour);//0-23,设置或读取为24小时制时间
  31   1          rtc_time[5] = ((time->minute > 59) ? 59 : time->minute);//0-59
  32   1          rtc_time[6] = ((time->second > 59) ? 59 : time->second);//0-59
  33   1      
  34   1          //把十进制数据转换成BCD码
  35   1          for(i = 0; i < 7; i++)
  36   1          {
  37   2              j = rtc_time[i] / 10;
  38   2              rtc_time[i] = rtc_time[i] % 10;
  39   2              rtc_time[i] = rtc_time[i] + j * 16;
  40   2          }
  41   1      
  42   1          for(i = 0; i < 7; i++)
  43   1          {
  44   2              gpio_i2c_write(DEV_ADDR_DS3231, ds3231_regaddr[i], rtc_time[i]);
  45   2          }
  46   1      }
  47          
  48          /*****************************************************************************
  49           函 数 名  : ds3231_read_time
  50           功能描述  : 获取当前时间
  51           输入参数  : void
  52           输出参数  : time   读取到的闹钟时间
  53           返 回 值  : 无
  54          *****************************************************************************/
C51 COMPILER V9.59.0.0   DRV_3231                                                          05/06/2019 23:08:40 PAGE 2   

  55          void ds3231_read_time(rtc_time_t *time)
  56          {
  57   1          uchar rtc_time[7] = {0};
  58   1          uchar i, temp;
  59   1          for(i = 0; i < 7; i++)
  60   1          {
  61   2              rtc_time[i] = gpio_i2c_read(DEV_ADDR_DS3231, ds3231_regaddr[i]);
  62   2              //把BCD码转换成十进制数据
  63   2              temp = rtc_time[i] / 16;
  64   2              rtc_time[i] = rtc_time[i] % 16;
  65   2              rtc_time[i] = rtc_time[i] + temp * 10;
  66   2          }
  67   1      
  68   1          time->year      = ((rtc_time[0] > 99) ? 99 : rtc_time[0]);//0-99
  69   1          time->week      = ((rtc_time[1] > 7) ? 7 : \
  70   1                             ((rtc_time[1] < 1) ? 1 : rtc_time[1]));//1-7
  71   1          time->month     = ((rtc_time[2] > 12) ? 12 : \
  72   1                             ((rtc_time[2] < 1) ? 1 : rtc_time[2]));//1-12
  73   1          time->day       = ((rtc_time[3] > 31) ? 31 : \
  74   1                             ((rtc_time[3] < 1) ? 1 : rtc_time[3]));//1-31
  75   1          time->hour      = ((rtc_time[4] > 23) ? 23 : rtc_time[4]);//0-23,设置或读取为24小时制时间
  76   1          time->minute    = ((rtc_time[5] > 59) ? 59 : rtc_time[5]);//0-59
  77   1          time->second    = ((rtc_time[6] > 59) ? 59 : rtc_time[6]);//0-59
  78   1      }
  79          
  80          /*****************************************************************************
  81           函 数 名  : ds3231_init
  82           功能描述  : RTC初始化
  83           输入参数  : void
  84           输出参数  : 无
  85           返 回 值  : 无
  86          *****************************************************************************/
  87          void ds3231_init(void)
  88          {
  89   1          gpio_i2c_init();
  90   1          //gpio_i2c_write(DEV_ADDR_DS3231, 0x0e, 0x1c);
  91   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    763    ----
   CONSTANT SIZE    =     21    ----
   XDATA SIZE       =   ----       7
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      16
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
